#!/usr/bin/env bash

COMPAAS_BIN="target/universal/stage/bin/compaas"
COMPAAS_OPTS="-Dconfig.resource=/dev.application.conf -Dlogback.configurationFile=src/main/resources/dev.logback.xml"

[ ! -d "$COMPAAS_BIN" ] && sbt clean stage

npx concurrently -n sbt-stage,cluster -c red,green \
"sbt -J-Xmx1024m '~stage'" \
"npx nodemon --delay 1 --watch target/universal/stage/lib \
    --exec \"npx concurrently -n node-1,node-2,node-3 -c yellow,magenta,cyan \
    'HOSTNAME=127.0.0.1 $COMPAAS_BIN $COMPAAS_OPTS' \
    'HOSTNAME=127.0.0.2 $COMPAAS_BIN $COMPAAS_OPTS' \
    'HOSTNAME=127.0.0.3 $COMPAAS_BIN $COMPAAS_OPTS'\""